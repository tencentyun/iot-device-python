* [网关使用示例](#网关使用示例)
  * [控制台创建设备](#控制台创建设备)
     *  [密钥认证接入](#密钥认证接入)
     *  [证书认证接入](#证书认证接入)
  * [填写认证连接设备的参数](#填写认证连接设备的参数)
  * [运行示例程序使网关设备进行 MQTT 认证连接上线](#运行示例程序使网关设备进行-MQTT-认证连接上线)
  * [网关下线](#网关下线)
  * [绑定子设备](#绑定子设备)
  * [解绑子设备](#解绑子设备)
  * [添加智能灯设备](#添加智能灯设备)
  * [删除智能灯设备](#删除智能灯设备)
  * [智能灯设备上线](#智能灯设备上线)
  * [智能灯设备下线](#智能灯设备下线)

# 网关使用示例

本文主要描述 SDK Demo 中网关设备的使用示例。

## 控制台创建设备

体验网关示例Demo需要在腾讯云物联网开发平台控制台（以下简称控制台）创建一个网关设备，一个智能灯设备，一个空调设备。请参考官网 [用户指南-网关设备接入](https://cloud.tencent.com/document/product/1081/43417)。 **注：需要将智能灯设备和空调设备绑定为网关设备的子设备**。

#### 密钥认证接入

示例中编辑 [device_info.json](../sample/device_info.json) 文件中的参数配置信息

```
{
    "auth_mode":"KEY",

    "productId":"YOUR_PRODUCT_ID",
    "productSecret":"YOUR_PRODUCT_SECRET",
    "deviceName":"",

    "key_deviceinfo":{    
        "deviceSecret":"YOUR_DEVICE_SECRET"
    },

    "cert_deviceinfo":{
        "devCertFile":"YOUR_DEVICE_CERT_FILE_NAME",
        "devPrivateKeyFile":"YOUR_DEVICE_PRIVATE_KEY_FILE_NAME"
    },

    "subDev":{
        "subdev_num":4,
        "subdev_list":
        [
                {"sub_productId": "", "sub_devName": ""},
                {"sub_productId": "", "sub_devName": ""},
                {"sub_productId": "", "sub_devName": ""},
                {"sub_productId": "", "sub_devName": ""}
        ]     
    },
	
    "region":"china"
}
```
如果控制台创建设备使用的是密钥认证方式，需要在 device_info.json 填写网关设备的 PRODUCT_ID（产品ID）、DEVICE_NAME（设备名称）、DEVICE_PSK（设备密钥），示例中使用的是密钥认证，SUB_PRODUCT_ID (智能灯等子设备产品ID)、 SUB_DEV_NAME (智能灯等子设备名称)、 SUB_DEV_PSK (智能灯等子设备密钥，绑定子设备时会用到)，SUB_PRODUCT_ID2 (空调设备等子设备产品ID)、 SUB_DEV_NAME2 (空调设备等子设备名称)、 SUB_DEV_PSK2 (空调设备等子设备密钥，绑定子设备时会用到)。

#### 证书认证接入

将证书和私钥放到 [resources](../sample)文件夹中。

如果控制台创建设备使用的是证书认证方式，除了需要在 device_info.json 除了需要在 device_info.json 填写 PRODUCT_ID（产品ID）、DEVICE_NAME（设备名称），还需填写 DEVICE_CERT_FILE_NAME (设备证书文件名称)、DEVICE_PRIVATE_KEY_FILE_NAME(设备私钥文件名称)

## 运行示例程序使网关设备进行 MQTT 认证连接上线 

运行 [example_gateway.py](../sample/gateway/example_gateway.py) ，进行认证连接，使网关设备上线。相关示例代码如下：

```
te = explorer.QcloudExplorer(device_file="./device_info.json")

te.user_on_publish = on_publish
te.user_on_subscribe = on_subscribe
te.mqttInit(mqtt_domain="")
te.connect()

te.gatewayInit()
```

观察输出日志。
```
2021-04-15 21:17:14,254.254 [hub.py:180] - DEBUG - subscribe success topic:$sys/operation/result/NCUL2VSYG6/test02
2021-04-15 21:17:14,254.254 [hub.py:180] - DEBUG - mid:1
2021-04-15 21:17:14,254.254 [hub.py:180] - DEBUG - pub topic:$sys/operation/NCUL2VSYG6/test02,payload:{'type': 'get', 'resource': ['time']},qos:0
2021-04-15 21:17:14,254.254 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m2), 'b'$sys/operation/NCUL2VSYG6/test02'', ... (37 bytes)
2021-04-15 21:17:14,254.254 [hub.py:180] - DEBUG - publish success
on_publish:mid:2,userdata:None
2021-04-15 21:17:14,300.300 [client.py:2404] - DEBUG - Received SUBACK
on_subscribe:mid:0,granted_qos:1,userdata:None
2021-04-15 21:17:14,310.310 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$sys/operation/result/NCUL2VSYG6/test02', ...  (82 bytes)
on_message:topic:$sys/operation/result/NCUL2VSYG6/test02,payload:{'type': 'get', 'time': 1618492625, 'ntptime1': 1618492625352, 'ntptime2': 1618492625352},qos:0,userdata:None
2021-04-15 21:17:14,912.912 [hub.py:180] - DEBUG - sub topic:$gateway/operation/result/NCUL2VSYG6/test02,qos:0
2021-04-15 21:17:14,912.912 [client.py:2404] - DEBUG - Sending SUBSCRIBE (d0, m3) [(b'$gateway/operation/result/NCUL2VSYG6/test02', 0)]
2021-04-15 21:17:14,912.912 [hub.py:180] - DEBUG - subscribe success topic:$gateway/operation/result/NCUL2VSYG6/test02
2021-04-15 21:17:14,913.913 [hub.py:180] - DEBUG - mid:3
2021-04-15 21:17:14,958.958 [client.py:2404] - DEBUG - Received SUBACK
on_subscribe:mid:0,granted_qos:3,userdata:None
```
以上是设备通过 MQTT 成功连接至云端并订阅网关设备关联的[数据模板协议](https://cloud.tencent.com/document/product/1081/34916) Topic 消息的日志，在控制台可查看该网关设备的状态已更新为在线。

## 网关下线

运行 [example_gateway.py](../sample/gateway/example_gateway.py) 的main函数，设备成功上线后，订阅过Topic后，调用`disconnect()`，使网关设备断开 MQTT 认证连接，网关设备下线。示例代码如下：

```
te.disconnect()
```

观察输出日志。
```
2021-04-15 21:21:22,177.177 [hub.py:180] - DEBUG - disconnect
2021-04-15 21:21:22,177.177 [client.py:2404] - DEBUG - Sending DISCONNECT
2021-04-15 21:21:22,178.178 [hub.py:188] - INFO - __on_disconnect,rc:0
2021-04-15 21:21:22,178.178 [hub.py:180] - DEBUG - LoopThread thread exit
on_disconnect:rc:0,userdata:None
```
以上为网关设备成功断开 MQTT 认证连接并取消订阅网关设备关联的[数据模板协议](https://cloud.tencent.com/document/product/1081/34916) Topic 消息的日志，在控制台可查看该网关设备的状态已更新为离线。

## 绑定子设备

运行 [example_gateway.py](../sample/gateway/example_gateway.py) 的main函数，设备成功上线后，订阅过Topic后，调用`gatewaySubdevBind()`, 将子设备绑定到指定的网关设备中。示例代码如下：

```
rc = te.gatewaySubdevBind(sub_productId, sub_devName, sub_devSecret)
if rc == 0:
    print("bind success")
else:
    print("bind fail")
```

以下是网关设备成功绑定子设备的输出日志，刷新观察控制台中的该网关设备下的子设备，选择对应绑定的子产品，即可查看到已绑定的子设备。

```
2021-04-15 21:28:53,261.261 [hub.py:180] - DEBUG - pub topic:$gateway/operation/NCUL2VSYG6/test02,payload:{'type': 'bind', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1', 'signature': 'YOUR_DEVICE_SECRET', 'random': 878629196, 'timestamp': 1618493333, 'signmethod': 'hmacsha1', 'authtype': 'psk'}]}},qos:0
2021-04-15 21:28:53,261.261 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m7), 'b'$gateway/operation/NCUL2VSYG6/test02'', ... (231 bytes)
2021-04-15 21:28:53,261.261 [hub.py:180] - DEBUG - publish success
2021-04-15 21:28:53,262.262 [hub.py:180] - DEBUG - client:Z53CXC198M/dev1 bind success
bind success
on_publish:mid:7,userdata:None
2021-04-15 21:28:53,330.330 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$gateway/operation/result/NCUL2VSYG6/test02', ...  (99 bytes)
2021-04-15 21:28:53,331.331 [hub.py:180] - DEBUG - gateway payload:{'type': 'bind', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1', 'result': 0}]}}
```

## 解绑子设备

运行 [example_gateway.py](../sample/gateway/example_gateway.py) 的main函数，设备成功上线后，订阅过Topic后，调用`gatewaySubdevUnbind()`，将子设备和指定的网关设备解绑。示例代码如下：

```
rc = te.gatewaySubdevUnbind(sub_productId, "YOUR_DEVICE_NAME", None)
if rc == 0:
    print("unbind success")
else:
    print("unbind fail")
```

以下是网关设备成功解绑子设备的输出日志，刷新观察控制台中的该网关设备下的子设备，选择对应绑定的子产品，之前已绑定的子设备已经不在子设备列表中，解绑成功。
```
2021-04-15 21:27:25,929.929 [hub.py:180] - DEBUG - pub topic:$gateway/operation/NCUL2VSYG6/test02,payload:{'type': 'unbind', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1'}]}},qos:0
2021-04-15 21:27:25,929.929 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m5), 'b'$gateway/operation/NCUL2VSYG6/test02'', ... (97 bytes)
2021-04-15 21:27:25,929.929 [hub.py:180] - DEBUG - publish success
on_publish:mid:5,userdata:None
2021-04-15 21:27:26,000.000 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$gateway/operation/result/NCUL2VSYG6/test02', ...  (101 bytes)
2021-04-15 21:27:26,000.000 [hub.py:180] - DEBUG - gateway payload:{'type': 'unbind', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1', 'result': 0}]}}
2021-04-15 21:27:26,130.130 [hub.py:180] - DEBUG - client:Z53CXC198M/dev1 unbind success
unbind success
```

## 网关代理子设备上线

运行 [example_gateway.py](../sample/gateway/example_gateway.py) 的main函数，设备成功上线后，订阅过Topic后，调用`gatewaySubdevOnline()`，发布子设备上线的 Topic 消息。示例代码如下：

```
te.gatewayInit()

# 获取到子设备信息后,在此维护设备状态,sdk中不处理设备状态
subdev_list = te.gateway_subdev_list

# 轮寻子设备列表，上线所有子设备
for subdev in subdev_list:
    if subdev.session_status is not QcloudHub.SessionState.SUBDEV_SEESION_STATUS_ONLINE:
        rc = te.gatewaySubdevOnline(subdev.sub_productId, subdev.sub_devName)
        if rc == 0:
            subdev.session_status = QcloudHub.SessionState.SUBDEV_SEESION_STATUS_ONLINE
            print("online success")
        else:
            print("online fail")
```

观察输出日志。
```
2021-04-15 21:41:44,079.079 [hub.py:180] - DEBUG - pub topic:$gateway/operation/NCUL2VSYG6/test02,payload:{'type': 'online', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1'}]}},qos:0
2021-04-15 21:41:44,079.079 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m4), 'b'$gateway/operation/NCUL2VSYG6/test02'', ... (97 bytes)
2021-04-15 21:41:44,080.080 [hub.py:180] - DEBUG - publish success
on_publish:mid:4,userdata:None
2021-04-15 21:41:44,156.156 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$gateway/operation/result/NCUL2VSYG6/test02', ...  (101 bytes)
2021-04-15 21:41:44,157.157 [hub.py:180] - DEBUG - gateway payload:{'type': 'online', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1', 'result': 0}]}}
2021-04-15 21:41:44,281.281 [hub.py:180] - DEBUG - client:Z53CXC198M/dev1 online success
online success
2021-04-15 21:41:44,281.281 [hub.py:180] - DEBUG - pub topic:$gateway/operation/NCUL2VSYG6/test02,payload:{'type': 'online', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev2'}]}},qos:0
2021-04-15 21:41:44,281.281 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m5), 'b'$gateway/operation/NCUL2VSYG6/test02'', ... (97 bytes)
2021-04-15 21:41:44,282.282 [hub.py:180] - DEBUG - publish success
on_publish:mid:5,userdata:None
2021-04-15 21:41:44,348.348 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$gateway/operation/result/NCUL2VSYG6/test02', ...  (101 bytes)
2021-04-15 21:41:44,349.349 [hub.py:180] - DEBUG - gateway payload:{'type': 'online', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev2', 'result': 0}]}}
2021-04-15 21:41:44,484.484 [hub.py:180] - DEBUG - client:Z53CXC198M/dev2 online success
online success
```
以上是网关设备成功发送子设备上线 Topic 并且网关设备接收到了子设备上线的 Topic 消息的日志。网关设备代理子设备上下线的 Topic ，请参考官网 [代理子设备上下线](https://cloud.tencent.com/document/product/1081/47442)。

## 网关代理子设备下线

运行 [example_gateway.py](../sample/gateway/example_gateway.py) 的main函数，设备成功上线后，订阅过Topic后，调用`gatewaySubdevOffline()`, 发布子设备下线的 Topic 消息。示例代码如下：

```
te.gatewayInit()

# 获取到子设备信息后,在此维护设备状态,sdk中不处理设备状态
subdev_list = te.gateway_subdev_list

# 轮寻子设备列表，下线所有子设备
for subdev in subdev_list:
    if subdev.session_status is not QcloudHub.SessionState.SUBDEV_SEESION_STATUS_OFFLINE:
        rc = te.gatewaySubdevOffline(subdev.sub_productId, subdev.sub_devName)
        if rc == 0:
            subdev.session_status = QcloudHub.SessionState.SUBDEV_SEESION_STATUS_OFFLINE
            print("online success")
        else:
            print("online fail")
```

观察输出日志。

```
2021-04-15 21:45:09,771.771 [hub.py:180] - DEBUG - pub topic:$gateway/operation/NCUL2VSYG6/test02,payload:{'type': 'offline', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1'}]}},qos:0
2021-04-15 21:45:09,771.771 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m8), 'b'$gateway/operation/NCUL2VSYG6/test02'', ... (98 bytes)
2021-04-15 21:45:09,772.772 [hub.py:180] - DEBUG - publish success
on_publish:mid:8,userdata:None
2021-04-15 21:45:09,857.857 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$gateway/operation/result/NCUL2VSYG6/test02', ...  (102 bytes)
2021-04-15 21:45:09,857.857 [hub.py:180] - DEBUG - gateway payload:{'type': 'offline', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev1', 'result': 0}]}}
2021-04-15 21:45:09,972.972 [hub.py:180] - DEBUG - client:Z53CXC198M/dev1 offline success
offline success
2021-04-15 21:45:09,972.972 [hub.py:180] - DEBUG - pub topic:$gateway/operation/NCUL2VSYG6/test02,payload:{'type': 'offline', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev2'}]}},qos:0
2021-04-15 21:45:09,973.973 [client.py:2404] - DEBUG - Sending PUBLISH (d0, q0, r0, m9), 'b'$gateway/operation/NCUL2VSYG6/test02'', ... (98 bytes)
2021-04-15 21:45:09,973.973 [hub.py:180] - DEBUG - publish success
on_publish:mid:9,userdata:None
2021-04-15 21:45:10,041.041 [client.py:2404] - DEBUG - Received PUBLISH (d0, q0, r0, m0), '$gateway/operation/result/NCUL2VSYG6/test02', ...  (102 bytes)
2021-04-15 21:45:10,041.041 [hub.py:180] - DEBUG - gateway payload:{'type': 'offline', 'payload': {'devices': [{'product_id': 'Z53CXC198M', 'device_name': 'dev2', 'result': 0}]}}
2021-04-15 21:45:10,175.175 [hub.py:180] - DEBUG - client:Z53CXC198M/dev2 offline success
offline success
```
以上是网关设备成功发送子设备下线 Topic 成功并且网关设备接收到了子设备下线的 Topic 消息的日志。网关设备代理子设备上下线的 Topic ，请参考官网 [代理子设备上下线](https://cloud.tencent.com/document/product/1081/47442)。
